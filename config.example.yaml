# TudoMesh Configuration - Example
# Copy this file to config.yaml and customize for your setup

mqtt:
  broker: "mqtt://localhost:1883"
  publishPrefix: "tudomesh"
  clientId: "tudomesh"
  # username: "mqtt_user"      # Optional MQTT authentication
  # password: "mqtt_password"

# Reference vacuum (optional)
# - If not specified: auto-selected by largest totalLayerArea
# - If specified: used as world coordinate origin
# - Auto-computed transforms are cached in .calibration-cache.json
reference: vacuum1  # Use vacuum1 as the reference coordinate system

# Vector rendering options (optional)
# gridSpacing: Grid line spacing in millimeters (default: 1000mm = 1m)
# vectorResolution: DPI for vector-to-PNG rasterization (default: 300)
# gridSpacing: 1000.0
# vectorResolution: 300.0

# Vacuum definitions
# Each vacuum requires: id, topic, color
# Optional fields:
# - rotation: Manual rotation hint/override in degrees (0, 90, 180, 270)
#   * Used as starting point for ICP alignment
#   * If provided, takes precedence over auto-computed rotation
# - translation: Manual translation override in pixels {x, y}
#   * Rarely needed - ICP usually computes this correctly
# - apiUrl: REST API URL for fetching the vacuum's full map data (optional)
#   * Required for auto-calibration on docking
#   * Format: http://<vacuum-ip>/api/v2/robot/state/map
#   * TudoMesh fetches the map via this URL when the vacuum docks
vacuums:
  # Reference vacuum - no rotation or translation needed
  - id: vacuum1
    topic: valetudo/YourVacuumID/MapData/map-data
    color: "#FF6B6B"
    apiUrl: "http://192.168.1.100/api/v2/robot/state/map"

  # Vacuum with rotation hint (recommended approach)
  - id: vacuum2
    topic: valetudo/AnotherVacuumID/MapData/map-data
    color: "#4ECDC4"
    rotation: 180  # ICP will use this as starting point
    apiUrl: "http://192.168.1.101/api/v2/robot/state/map"

  # Vacuum with full manual calibration (advanced/rare)
  - id: vacuum3
    topic: valetudo/ThirdVacuumID/MapData/map-data
    color: "#45B7D1"
    rotation: 270
    translation:
      x: 50
      y: -100
    apiUrl: "http://192.168.1.102/api/v2/robot/state/map"

# Calibration workflow:
# 1. Rotation hints in config are used as ICP starting points
# 2. ICP computes full AffineMatrix transforms (rotation + translation)
# 3. Transforms are cached in .calibration-cache.json
# 4. Manual overrides in config take precedence over cache
# 5. CLI --force-rotation flag overrides everything
#
# Common patterns:
#
# 1. Auto-calibration (recommended for first time):
#    - Don't set rotation hints
#    - Run: ./tudomesh --calibrate
#    - Check output to see detected rotations
#    - Add rotation hints to config.yaml
#
# 2. With rotation hints (recommended for production):
#    - Set rotation hints in config.yaml based on calibration results
#    - ICP will start from these hints and fine-tune
#    - Much faster and more reliable than full auto-calibration
#
# 3. CLI override (testing/troubleshooting):
#    - ./tudomesh --render --force-rotation="vacuum2=180,vacuum3=270"
#    - Overrides both config and cache
#
# 4. Manual calibration (rare - only if ICP fails):
#    - Set both rotation and translation in config.yaml
#    - Bypasses ICP completely for that vacuum

# Auto-calibration on docking:
#
# When a vacuum docks (returns to charger), TudoMesh can automatically
# recalibrate its coordinate transform. This keeps alignment accurate
# as the vacuum's map evolves over time.
#
# Requirements:
#   - apiUrl must be set for each vacuum you want auto-calibrated
#   - The vacuum must publish state updates to its StatusStateAttribute topic
#     (auto-derived from the MapData topic)
#
# How it works:
#   1. TudoMesh subscribes to valetudo/{name}/StatusStateAttribute/status
#      (derived automatically from the MapData topic)
#   2. When a "docked" state is received, the docking handler fires
#   3. TudoMesh checks if recalibration is needed (30-minute debounce)
#   4. If needed, it fetches the full map via the vacuum's apiUrl
#   5. ICP alignment runs against the reference vacuum
#   6. The updated transform is saved to .calibration-cache.json
#
# State topic derivation:
#   MapData topic:  valetudo/rocky7/MapData/map-data
#   State topic:    valetudo/rocky7/StatusStateAttribute/status
#   (The last two path segments are replaced automatically)
